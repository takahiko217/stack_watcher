# Stack Watcher フロントエンド設計書

## 1. 概要

### 1.1 技術スタック
- **フレームワーク**: Vue.js 3 (Composition API)
- **グラフライブラリ**: Apache ECharts 5.x
- **CSSフレームワーク**: Tailwind CSS 3.x
- **ビルドツール**: Vite 4.x
- **状態管理**: Pinia
- **HTTP クライアント**: Axios
- **ルーティング**: Vue Router 4

### 1.2 設計原則
- コンポーネント指向設計
- 単一責任の原則
- 再利用可能なコンポーネント
- レスポンシブデザイン
- アクセシビリティ対応

## 2. アーキテクチャ

### 2.1 ディレクトリ構造
```
frontend/
├── public/
│   └── favicon.ico
├── src/
│   ├── components/
│   │   ├── common/
│   │   │   ├── BaseButton.vue
│   │   │   ├── BaseLoading.vue
│   │   │   └── BaseModal.vue
│   │   ├── layout/
│   │   │   ├── AppHeader.vue
│   │   │   ├── AppSidebar.vue
│   │   │   └── AppFooter.vue
│   │   └── charts/
│   │       ├── BaseChart.vue
│   │       ├── StockChart.vue
│   │       └── ChartContainer.vue
│   ├── views/
│   │   ├── Dashboard.vue
│   │   └── About.vue
│   ├── stores/
│   │   ├── stockStore.js
│   │   ├── uiStore.js
│   │   └── colorStore.js
│   ├── services/
│   │   ├── api.js
│   │   ├── stockService.js
│   │   └── chartService.js
│   ├── composables/
│   │   ├── useChart.js
│   │   ├── useStock.js
│   │   └── useResize.js
│   ├── utils/
│   │   ├── dateUtils.js
│   │   ├── chartUtils.js
│   │   └── formatUtils.js
│   ├── constants/
│   │   ├── colors.js
│   │   ├── chartConfig.js
│   │   └── api.js
│   ├── assets/
│   │   └── styles/
│   │       └── main.css
│   ├── router/
│   │   └── index.js
│   ├── App.vue
│   └── main.js
├── index.html
├── vite.config.js
├── tailwind.config.js
├── package.json
└── README.md
```

### 2.2 状態管理（Pinia Store）

#### Stock Store
```javascript
// stores/stockStore.js
export const useStockStore = defineStore('stock', {
  state: () => ({
    stocks: [],
    selectedSymbols: ['6326', '9984', '1377'],
    period: '7d',
    isLoading: false,
    error: null,
    lastUpdated: null
  }),
  
  getters: {
    getStockBySymbol: (state) => (symbol) => {
      return state.stocks.find(stock => stock.symbol === symbol)
    },
    
    hasData: (state) => state.stocks.length > 0,
    
    formattedStocks: (state) => {
      return state.stocks.map(stock => ({
        ...stock,
        data_points: stock.data_points.map(point => ({
          ...point,
          date: new Date(point.date)
        }))
      }))
    }
  },
  
  actions: {
    async fetchStocks() {
      this.isLoading = true
      this.error = null
      
      try {
        const symbols = this.selectedSymbols.join(',')
        const response = await stockService.getStocks(symbols, this.period)
        this.stocks = response.data.stocks
        this.lastUpdated = new Date()
      } catch (error) {
        this.error = error.message
        console.error('Failed to fetch stocks:', error)
      } finally {
        this.isLoading = false
      }
    },
    
    setPeriod(period) {
      this.period = period
      this.fetchStocks()
    },
    
    addSymbol(symbol) {
      if (!this.selectedSymbols.includes(symbol)) {
        this.selectedSymbols.push(symbol)
        this.fetchStocks()
      }
    },
    
    removeSymbol(symbol) {
      this.selectedSymbols = this.selectedSymbols.filter(s => s !== symbol)
      this.stocks = this.stocks.filter(stock => stock.symbol !== symbol)
    }
  }
})
```

#### UI Store
```javascript
// stores/uiStore.js
export const useUIStore = defineStore('ui', {
  state: () => ({
    sidebarExpanded: false,
    isMobile: false,
    chartSyncEnabled: true,
    timeRange: {
      start: null,
      end: null
    }
  }),
  
  actions: {
    toggleSidebar() {
      this.sidebarExpanded = !this.sidebarExpanded
    },
    
    setMobile(isMobile) {
      this.isMobile = isMobile
      if (isMobile) {
        this.sidebarExpanded = false
      }
    },
    
    setTimeRange(start, end) {
      this.timeRange = { start, end }
    }
  }
})
```

#### Color Store
```javascript
// stores/colorStore.js
export const useColorStore = defineStore('color', {
  state: () => ({
    colors: {
      stocks: {},
      system: {}
    }
  }),
  
  actions: {
    async fetchColors() {
      try {
        const response = await api.get('/colors/master')
        this.colors = response.data.data.colors
      } catch (error) {
        console.error('Failed to fetch colors:', error)
      }
    }
  }
})
```

## 3. コンポーネント設計

### 3.1 レイアウトコンポーネント

#### App.vue（ルートコンポーネント）
```vue
<template>
  <div id="app" class="min-h-screen bg-gray-50">
    <AppHeader />
    <div class="flex">
      <AppSidebar />
      <main class="flex-1 transition-all duration-300" 
            :class="{ 'ml-16': !sidebarExpanded, 'ml-72': sidebarExpanded }">
        <router-view />
      </main>
    </div>
    <AppFooter />
  </div>
</template>

<script setup>
import { computed, onMounted } from 'vue'
import { useUIStore } from '@/stores/uiStore'
import { useColorStore } from '@/stores/colorStore'
import AppHeader from '@/components/layout/AppHeader.vue'
import AppSidebar from '@/components/layout/AppSidebar.vue'
import AppFooter from '@/components/layout/AppFooter.vue'

const uiStore = useUIStore()
const colorStore = useColorStore()

const sidebarExpanded = computed(() => uiStore.sidebarExpanded)

onMounted(() => {
  colorStore.fetchColors()
  
  // レスポンシブ対応
  const handleResize = () => {
    uiStore.setMobile(window.innerWidth < 768)
  }
  
  window.addEventListener('resize', handleResize)
  handleResize()
})
</script>
```

#### AppHeader.vue
```vue
<template>
  <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
    <div class="px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <!-- ロゴ -->
        <div class="flex items-center">
          <h1 class="text-xl font-bold text-primary-900">
            Stack Watcher
          </h1>
        </div>
        
        <!-- 期間選択 -->
        <div class="flex items-center space-x-4">
          <PeriodSelector />
          <button
            @click="refreshData"
            :disabled="isLoading"
            class="btn-primary"
          >
            <RefreshIcon class="w-4 h-4" />
            更新
          </button>
        </div>
      </div>
    </div>
  </header>
</template>

<script setup>
import { computed } from 'vue'
import { useStockStore } from '@/stores/stockStore'
import PeriodSelector from '@/components/common/PeriodSelector.vue'
import { RefreshIcon } from '@heroicons/vue/24/outline'

const stockStore = useStockStore()

const isLoading = computed(() => stockStore.isLoading)

const refreshData = () => {
  stockStore.fetchStocks()
}
</script>
```

#### AppSidebar.vue
```vue
<template>
  <aside 
    class="fixed left-0 top-16 h-full bg-white shadow-lg transition-all duration-300 z-30"
    :class="{ 'w-16': !expanded, 'w-72': expanded }"
    @mouseenter="handleMouseEnter"
    @mouseleave="handleMouseLeave"
  >
    <div class="p-4">
      <!-- 銘柄選択 -->
      <div v-if="expanded" class="mb-6">
        <h3 class="text-sm font-medium text-gray-900 mb-3">選択銘柄</h3>
        <div class="space-y-2">
          <label 
            v-for="symbol in availableSymbols" 
            :key="symbol.code"
            class="flex items-center"
          >
            <input
              type="checkbox"
              :value="symbol.code"
              v-model="selectedSymbols"
              @change="handleSymbolChange"
              class="checkbox"
            />
            <span class="ml-2 text-sm text-gray-700">
              {{ symbol.name }}
            </span>
          </label>
        </div>
      </div>
      
      <!-- アイコンのみ表示（折りたたみ時） -->
      <div v-else class="flex flex-col items-center space-y-4">
        <button 
          v-for="symbol in selectedSymbols" 
          :key="symbol"
          class="w-8 h-8 rounded-full"
          :style="{ backgroundColor: getStockColor(symbol) }"
          :title="getStockName(symbol)"
        >
          <span class="text-white text-xs font-bold">
            {{ symbol.slice(-2) }}
          </span>
        </button>
      </div>
    </div>
  </aside>
</template>

<script setup>
import { ref, computed } from 'vue'
import { useStockStore } from '@/stores/stockStore'
import { useColorStore } from '@/stores/colorStore'
import { useUIStore } from '@/stores/uiStore'

const stockStore = useStockStore()
const colorStore = useColorStore()
const uiStore = useUIStore()

const expanded = computed(() => uiStore.sidebarExpanded)
const selectedSymbols = computed({
  get: () => stockStore.selectedSymbols,
  set: (value) => stockStore.selectedSymbols = value
})

const availableSymbols = [
  { code: '6326', name: 'クボタ' },
  { code: '9984', name: 'ソフトバンク' },
  { code: '1377', name: 'サカタのタネ' }
]

const handleMouseEnter = () => {
  if (!uiStore.isMobile) {
    uiStore.sidebarExpanded = true
  }
}

const handleMouseLeave = () => {
  if (!uiStore.isMobile) {
    uiStore.sidebarExpanded = false
  }
}

const handleSymbolChange = () => {
  stockStore.fetchStocks()
}

const getStockColor = (symbol) => {
  return colorStore.colors.stocks[symbol] || '#6b7280'
}

const getStockName = (symbol) => {
  return availableSymbols.find(s => s.code === symbol)?.name || symbol
}
</script>
```

### 3.2 チャートコンポーネント

#### BaseChart.vue（基本チャートコンポーネント）
```vue
<template>
  <div 
    ref="chartContainer"
    class="w-full"
    :style="{ height: height + 'px' }"
  />
</template>

<script setup>
import { ref, onMounted, onUnmounted, watch, nextTick } from 'vue'
import * as echarts from 'echarts'
import { useResize } from '@/composables/useResize'

const props = defineProps({
  options: {
    type: Object,
    required: true
  },
  height: {
    type: Number,
    default: 400
  },
  loading: {
    type: Boolean,
    default: false
  }
})

const emit = defineEmits(['chart-ready', 'chart-click', 'data-zoom'])

const chartContainer = ref(null)
const chartInstance = ref(null)

// レスポンシブ対応
const { width } = useResize()

const initChart = async () => {
  await nextTick()
  
  if (chartInstance.value) {
    chartInstance.value.dispose()
  }
  
  chartInstance.value = echarts.init(chartContainer.value)
  
  // イベントリスナー
  chartInstance.value.on('click', (params) => {
    emit('chart-click', params)
  })
  
  chartInstance.value.on('dataZoom', (params) => {
    emit('data-zoom', params)
  })
  
  chartInstance.value.setOption(props.options)
  emit('chart-ready', chartInstance.value)
}

const updateChart = () => {
  if (chartInstance.value) {
    chartInstance.value.setOption(props.options, true)
  }
}

const showLoading = () => {
  if (chartInstance.value) {
    chartInstance.value.showLoading('default', {
      text: '読み込み中...',
      color: '#1e40af',
      textColor: '#374151',
      maskColor: 'rgba(255, 255, 255, 0.8)'
    })
  }
}

const hideLoading = () => {
  if (chartInstance.value) {
    chartInstance.value.hideLoading()
  }
}

const resize = () => {
  if (chartInstance.value) {
    chartInstance.value.resize()
  }
}

// ライフサイクル
onMounted(() => {
  initChart()
})

onUnmounted(() => {
  if (chartInstance.value) {
    chartInstance.value.dispose()
  }
})

// ウォッチャー
watch(() => props.options, updateChart, { deep: true })
watch(() => props.loading, (isLoading) => {
  if (isLoading) {
    showLoading()
  } else {
    hideLoading()
  }
})
watch(width, resize)

// 外部から呼び出し可能なメソッド
defineExpose({
  getInstance: () => chartInstance.value,
  resize
})
</script>
```

#### StockChart.vue
```vue
<template>
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-medium text-gray-900">株価推移</h3>
      <div class="flex items-center space-x-2">
        <span 
          v-for="stock in stocks" 
          :key="stock.symbol"
          class="flex items-center space-x-1"
        >
          <div 
            class="w-3 h-3 rounded-full"
            :style="{ backgroundColor: getStockColor(stock.symbol) }"
          />
          <span class="text-sm text-gray-600">{{ stock.company_name }}</span>
        </span>
      </div>
    </div>
    
    <BaseChart
      ref="chart"
      :options="chartOptions"
      :loading="isLoading"
      :height="400"
      @data-zoom="handleDataZoom"
    />
  </div>
</template>

<script setup>
import { computed, ref } from 'vue'
import { useStockStore } from '@/stores/stockStore'
import { useColorStore } from '@/stores/colorStore'
import { useUIStore } from '@/stores/uiStore'
import BaseChart from '@/components/charts/BaseChart.vue'
import { formatCurrency, formatDate } from '@/utils/formatUtils'

const stockStore = useStockStore()
const colorStore = useColorStore()
const uiStore = useUIStore()

const chart = ref(null)

const stocks = computed(() => stockStore.formattedStocks)
const isLoading = computed(() => stockStore.isLoading)

const chartOptions = computed(() => {
  if (!stocks.value || stocks.value.length === 0) {
    return {}
  }

  const series = stocks.value.map(stock => ({
    name: stock.company_name,
    type: 'line',
    symbol: 'circle',
    symbolSize: 6,
    lineStyle: {
      width: 2,
      color: getStockColor(stock.symbol)
    },
    itemStyle: {
      color: getStockColor(stock.symbol)
    },
    data: stock.data_points.map(point => [
      point.date.getTime(),
      point.close
    ])
  }))

  return {
    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'cross'
      },
      formatter: (params) => {
        let html = `<div class="text-sm">`
        html += `<div class="font-medium mb-2">${formatDate(params[0].data[0])}</div>`
        
        params.forEach(param => {
          html += `
            <div class="flex items-center justify-between">
              <span class="flex items-center">
                <span class="w-2 h-2 rounded-full mr-2" style="background-color: ${param.color}"></span>
                ${param.seriesName}
              </span>
              <span class="font-medium">${formatCurrency(param.data[1])}</span>
            </div>
          `
        })
        
        html += `</div>`
        return html
      }
    },
    legend: {
      show: false
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '10%',
      containLabel: true
    },
    xAxis: {
      type: 'time',
      boundaryGap: false,
      axisLine: {
        lineStyle: {
          color: '#e5e7eb'
        }
      },
      axisLabel: {
        color: '#6b7280',
        formatter: (value) => formatDate(value, 'MM/DD')
      }
    },
    yAxis: {
      type: 'value',
      scale: true,
      axisLine: {
        show: false
      },
      axisTick: {
        show: false
      },
      axisLabel: {
        color: '#6b7280',
        formatter: (value) => formatCurrency(value)
      },
      splitLine: {
        lineStyle: {
          color: '#f3f4f6'
        }
      }
    },
    dataZoom: [
      {
        type: 'inside',
        start: 0,
        end: 100
      }
    ],
    series
  }
})

const getStockColor = (symbol) => {
  return colorStore.colors.stocks[symbol] || '#6b7280'
}

const handleDataZoom = (params) => {
  if (uiStore.chartSyncEnabled) {
    // 他のチャートと同期
    uiStore.setTimeRange(params.start, params.end)
  }
}
</script>
```

## 4. Composables（再利用可能なロジック）

### 4.1 useChart.js
```javascript
import { ref, reactive, computed } from 'vue'
import * as echarts from 'echarts'

export function useChart(containerRef) {
  const chart = ref(null)
  const loading = ref(false)
  const error = ref(null)

  const initChart = () => {
    if (!containerRef.value) return
    
    chart.value = echarts.init(containerRef.value)
    return chart.value
  }

  const setOption = (option, notMerge = false) => {
    if (!chart.value) return
    
    loading.value = true
    try {
      chart.value.setOption(option, notMerge)
    } catch (err) {
      error.value = err.message
    } finally {
      loading.value = false
    }
  }

  const resize = () => {
    if (chart.value) {
      chart.value.resize()
    }
  }

  const dispose = () => {
    if (chart.value) {
      chart.value.dispose()
      chart.value = null
    }
  }

  return {
    chart: computed(() => chart.value),
    loading: computed(() => loading.value),
    error: computed(() => error.value),
    initChart,
    setOption,
    resize,
    dispose
  }
}
```

### 4.2 useStock.js
```javascript
import { computed } from 'vue'
import { useStockStore } from '@/stores/stockStore'

export function useStock() {
  const stockStore = useStockStore()

  const stocks = computed(() => stockStore.formattedStocks)
  const isLoading = computed(() => stockStore.isLoading)
  const error = computed(() => stockStore.error)
  const selectedSymbols = computed(() => stockStore.selectedSymbols)

  const fetchStocks = async () => {
    await stockStore.fetchStocks()
  }

  const setPeriod = (period) => {
    stockStore.setPeriod(period)
  }

  const getStockBySymbol = (symbol) => {
    return stockStore.getStockBySymbol(symbol)
  }

  return {
    stocks,
    isLoading,
    error,
    selectedSymbols,
    fetchStocks,
    setPeriod,
    getStockBySymbol
  }
}
```

## 5. ユーティリティ関数

### 5.1 formatUtils.js
```javascript
export const formatCurrency = (value, currency = 'JPY') => {
  return new Intl.NumberFormat('ja-JP', {
    style: 'currency',
    currency: currency,
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(value)
}

export const formatDate = (date, format = 'YYYY/MM/DD') => {
  const d = new Date(date)
  
  const formats = {
    'YYYY/MM/DD': `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`,
    'MM/DD': `${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`,
    'HH:mm': `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`
  }
  
  return formats[format] || d.toLocaleDateString('ja-JP')
}

export const formatNumber = (value, decimals = 2) => {
  return new Intl.NumberFormat('ja-JP', {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals
  }).format(value)
}
```

## 6. 定数・設定

### 6.1 chartConfig.js
```javascript
export const CHART_COLORS = {
  stocks: {
    '6326': '#2563eb', // クボタ - 青
    '9984': '#dc2626', // ソフトバンク - 赤  
    '1377': '#059669'  // サカタのタネ - 緑
  },
  grid: '#f3f4f6',
  text: '#6b7280',
  border: '#e5e7eb'
}

export const CHART_DEFAULTS = {
  height: 400,
  animation: true,
  animationDuration: 300,
  tooltip: {
    trigger: 'axis',
    axisPointer: {
      type: 'cross'
    }
  },
  grid: {
    left: '3%',
    right: '4%',
    bottom: '10%',
    containLabel: true
  }
}
```

## 7. レスポンシブ対応

### 7.1 ブレークポイント定義
```javascript
// tailwind.config.js
module.exports = {
  theme: {
    screens: {
      'sm': '640px',
      'md': '768px',
      'lg': '1024px',
      'xl': '1280px',
      '2xl': '1536px',
    }
  }
}
```

### 7.2 モバイル対応
- サイドバーはハンバーガーメニューに変更
- チャートは縦スクロール配置
- タッチ操作対応
- フォントサイズ調整

## 8. アクセシビリティ

### 8.1 対応項目
- キーボードナビゲーション
- スクリーンリーダー対応
- 色のコントラスト比確保
- フォーカス管理
- ARIAラベル設定

---

**作成日**: 2025年9月20日  
**バージョン**: 1.0  
**対象フェーズ**: Phase 1 MVP