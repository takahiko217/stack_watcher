# Stack Watcher ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸

## 1. æ¦‚è¦

### 1.1 åŸºæœ¬æ–¹é‡
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã›ãšã€å¤–éƒ¨APIã‹ã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
- å¿…è¦æœ€å°é™ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- è¤‡æ•°ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®çµ±åˆã¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½

### 1.2 å¯¾è±¡ãƒ‡ãƒ¼ã‚¿
- **æ ªä¾¡ãƒ‡ãƒ¼ã‚¿**: ã‚¯ãƒœã‚¿(6326)ã€ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯(9984)ã€ã‚µã‚«ã‚¿ã®ã‚¿ãƒ(1377)
- **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿**: æ—¥çµŒ225ã€TOPIXã€ãƒã‚¶ãƒ¼ã‚ºæŒ‡æ•°
- **æ°—è±¡ãƒ‡ãƒ¼ã‚¿**: é™æ°´é‡ã€æ°—æ¸©ã€æ°—åœ§ï¼ˆæ±äº¬éƒ½ï¼‰

## 2. åˆ©ç”¨å¯èƒ½ãªæ ªä¾¡ãƒ‡ãƒ¼ã‚¿API

### 2.1 æ¨å¥¨APIï¼ˆç„¡æ–™ï¼‰

#### 2.1.1 ğŸ¥‡ Alpha Vantage
- **URL**: https://www.alphavantage.co/
- **ç„¡æ–™æ **: 25ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ—¥ï¼ˆAPI KEYå¿…è¦ï¼‰
- **æ—¥æœ¬æ ªå¯¾å¿œ**: â—‹ï¼ˆæ±è¨¼éŠ˜æŸ„å¯¾å¿œï¼‰
- **ãƒ‡ãƒ¼ã‚¿å½¢å¼**: JSON/CSV
- **é…å»¶**: 15-20åˆ†é…å»¶
- **åˆ©ç”¨æ–¹æ³•**:
```
https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=6326.T&apikey=YOUR_API_KEY
```

#### 2.1.2 ğŸ¥ˆ Yahoo Finance API (éå…¬å¼)
- **ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: `yfinance` (Python)
- **ç„¡æ–™æ **: åˆ¶é™ãªã—ï¼ˆåˆ©ç”¨è¦ç´„ã«æ³¨æ„ï¼‰
- **æ—¥æœ¬æ ªå¯¾å¿œ**: â—‹ï¼ˆ.T ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼‰
- **ãƒ‡ãƒ¼ã‚¿å½¢å¼**: pandas DataFrame
- **é…å»¶**: 15-20åˆ†é…å»¶
- **åˆ©ç”¨æ–¹æ³•**:
```python
import yfinance as yf
ticker = yf.Ticker("6326.T")
data = ticker.history(period="7d")
```

#### 2.1.3 ğŸ¥‰ Stooq
- **URL**: https://stooq.com/
- **ç„¡æ–™æ **: åˆ¶é™ãªã—
- **æ—¥æœ¬æ ªå¯¾å¿œ**: â—‹
- **ãƒ‡ãƒ¼ã‚¿å½¢å¼**: CSV
- **é…å»¶**: 15-20åˆ†é…å»¶
- **åˆ©ç”¨æ–¹æ³•**:
```
https://stooq.com/q/d/l/?s=6326.jp&f=sd2t2ohlcv&h&e=csv
```

### 2.2 ãã®ä»–ã®é¸æŠè‚¢

#### Financial Modeling Prep
- **ç„¡æ–™æ **: 250ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ—¥
- **æ—¥æœ¬æ ªå¯¾å¿œ**: â—‹
- **URL**: https://financialmodelingprep.com/

#### Twelve Data
- **ç„¡æ–™æ **: 800ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ—¥
- **æ—¥æœ¬æ ªå¯¾å¿œ**: â—‹
- **URL**: https://twelvedata.com/

## 3. æ°—è±¡ãƒ‡ãƒ¼ã‚¿API

### 3.1 æ¨å¥¨API

#### 3.1.1 ğŸ¥‡ æ°—è±¡åºAPIï¼ˆæ—¥æœ¬æ°—è±¡å”ä¼šï¼‰
- **URL**: https://www.jma.go.jp/bosai/forecast/
- **ç„¡æ–™æ **: åˆ¶é™ãªã—
- **ãƒ‡ãƒ¼ã‚¿**: å¤©æ°—äºˆå ±ã€é™æ°´é‡ã€æ°—æ¸©ã€æ°—åœ§
- **åˆ©ç”¨æ–¹æ³•**:
```
https://www.jma.go.jp/bosai/forecast/data/forecast/130000.json
```

#### 3.1.2 ğŸ¥ˆ OpenWeatherMap
- **URL**: https://openweathermap.org/
- **ç„¡æ–™æ **: 1000ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ—¥
- **ãƒ‡ãƒ¼ã‚¿**: ç¾åœ¨ãƒ»å±¥æ­´ãƒ»äºˆå ±ãƒ‡ãƒ¼ã‚¿
- **åˆ©ç”¨æ–¹æ³•**:
```
https://api.openweathermap.org/data/2.5/weather?q=Tokyo&appid=YOUR_API_KEY
```

## 4. æ¨å¥¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 4.1 ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠ

#### Phase 1 MVPï¼ˆæ¨å¥¨æ§‹æˆï¼‰
```python
# æ ªä¾¡ãƒ‡ãƒ¼ã‚¿
PRIMARY: yfinance (Yahoo Finance)
FALLBACK: Alpha Vantage

# æ°—è±¡ãƒ‡ãƒ¼ã‚¿  
PRIMARY: æ°—è±¡åºAPI
FALLBACK: OpenWeatherMap
```

### 4.2 ç†ç”±
- **yfinance**: ç„¡æ–™ã§åˆ¶é™ãŒç·©ãã€æ—¥æœ¬æ ªå¯¾å¿œãŒè‰¯ã„
- **æ°—è±¡åºAPI**: æ—¥æœ¬ã®å…¬å¼ãƒ‡ãƒ¼ã‚¿ã§ä¿¡é ¼æ€§ãŒé«˜ã„
- **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: ä¸»è¦APIãŒãƒ€ã‚¦ãƒ³ã—ãŸå ´åˆã®å†—é•·æ€§

## 5. ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

### 5.1 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ§‹æˆ
```
Frontend (Vue.js)
    â†“ HTTP Request
Backend (FastAPI)
    â”œâ”€â”€ Stock Service
    â”‚   â”œâ”€â”€ Yahoo Finance Client
    â”‚   â””â”€â”€ Alpha Vantage Client (Fallback)
    â”œâ”€â”€ Weather Service  
    â”‚   â”œâ”€â”€ JMA Client
    â”‚   â””â”€â”€ OpenWeather Client (Fallback)
    â””â”€â”€ Cache Layer (Redis/Memory)
```

### 5.2 ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

#### 5.2.1 ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœŸé–“
```python
CACHE_PERIODS = {
    "stock_data": 900,      # 15åˆ†ï¼ˆå¸‚å ´ãƒ‡ãƒ¼ã‚¿æ›´æ–°é–“éš”ï¼‰
    "weather_data": 1800,   # 30åˆ†ï¼ˆæ°—è±¡ãƒ‡ãƒ¼ã‚¿æ›´æ–°é–“éš”ï¼‰
    "symbols_master": 86400 # 24æ™‚é–“ï¼ˆãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼‰
}
```

#### 5.2.2 ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼è¨­è¨ˆ
```python
# æ ªä¾¡ãƒ‡ãƒ¼ã‚¿
"stock:{symbol}:{period}:{date}"
# ä¾‹: "stock:6326:7d:2025-09-20"

# æ°—è±¡ãƒ‡ãƒ¼ã‚¿
"weather:{location}:{date}"
# ä¾‹: "weather:tokyo:2025-09-20"
```

## 6. å®Ÿè£…è¨­è¨ˆ

### 6.1 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…

#### 6.1.1 Stock Service
```python
# backend/services/stock_service.py
import yfinance as yf
import requests
from typing import List, Dict, Optional
from datetime import datetime, timedelta
import asyncio

class StockService:
    def __init__(self):
        self.alpha_vantage_key = os.getenv("ALPHA_VANTAGE_API_KEY")
        self.symbols_map = {
            "6326": "6326.T",  # ã‚¯ãƒœã‚¿
            "9984": "9984.T",  # ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯
            "1377": "1377.T"   # ã‚µã‚«ã‚¿ã®ã‚¿ãƒ
        }
    
    async def get_stock_data(self, symbol: str, period: str) -> Dict:
        """æ ªä¾¡ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆãƒ—ãƒ©ã‚¤ãƒãƒª: yfinanceï¼‰"""
        try:
            return await self._get_yahoo_finance_data(symbol, period)
        except Exception as e:
            print(f"Yahoo Finance failed: {e}")
            return await self._get_alpha_vantage_data(symbol, period)
    
    async def _get_yahoo_finance_data(self, symbol: str, period: str) -> Dict:
        """Yahoo Finance ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—"""
        yahoo_symbol = self.symbols_map.get(symbol)
        if not yahoo_symbol:
            raise ValueError(f"Unsupported symbol: {symbol}")
        
        # éåŒæœŸå®Ÿè¡Œã®ãŸã‚ executor ã‚’ä½¿ç”¨
        loop = asyncio.get_event_loop()
        ticker = yf.Ticker(yahoo_symbol)
        data = await loop.run_in_executor(
            None, 
            lambda: ticker.history(period=period)
        )
        
        return self._format_stock_data(symbol, data)
    
    async def _get_alpha_vantage_data(self, symbol: str, period: str) -> Dict:
        """Alpha Vantage ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰"""
        if not self.alpha_vantage_key:
            raise ValueError("Alpha Vantage API key not configured")
        
        url = f"https://www.alphavantage.co/query"
        params = {
            "function": "TIME_SERIES_DAILY",
            "symbol": f"{symbol}.T",
            "apikey": self.alpha_vantage_key
        }
        
        async with httpx.AsyncClient() as client:
            response = await client.get(url, params=params)
            data = response.json()
            
        return self._format_alpha_vantage_data(symbol, data)
    
    def _format_stock_data(self, symbol: str, data) -> Dict:
        """ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆçµ±ä¸€"""
        formatted_data = []
        for date, row in data.iterrows():
            formatted_data.append({
                "date": date.isoformat(),
                "open": float(row["Open"]),
                "high": float(row["High"]),
                "low": float(row["Low"]),
                "close": float(row["Close"]),
                "volume": int(row["Volume"])
            })
        
        return {
            "symbol": symbol,
            "company_name": self._get_company_name(symbol),
            "data_points": formatted_data
        }
```

#### 6.1.2 Weather Service
```python
# backend/services/weather_service.py
import httpx
from typing import Dict
import asyncio

class WeatherService:
    def __init__(self):
        self.openweather_key = os.getenv("OPENWEATHER_API_KEY")
        self.jma_base_url = "https://www.jma.go.jp/bosai"
    
    async def get_weather_data(self, location: str = "tokyo") -> Dict:
        """æ°—è±¡ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆãƒ—ãƒ©ã‚¤ãƒãƒª: æ°—è±¡åºï¼‰"""
        try:
            return await self._get_jma_data()
        except Exception as e:
            print(f"JMA API failed: {e}")
            return await self._get_openweather_data(location)
    
    async def _get_jma_data(self) -> Dict:
        """æ°—è±¡åºãƒ‡ãƒ¼ã‚¿å–å¾—"""
        url = f"{self.jma_base_url}/forecast/data/forecast/130000.json"
        
        async with httpx.AsyncClient() as client:
            response = await client.get(url)
            data = response.json()
            
        return self._format_jma_data(data)
    
    async def _get_openweather_data(self, location: str) -> Dict:
        """OpenWeatherMap ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰"""
        if not self.openweather_key:
            raise ValueError("OpenWeather API key not configured")
        
        url = "https://api.openweathermap.org/data/2.5/weather"
        params = {
            "q": location,
            "appid": self.openweather_key,
            "units": "metric"
        }
        
        async with httpx.AsyncClient() as client:
            response = await client.get(url, params=params)
            data = response.json()
            
        return self._format_openweather_data(data)
```

### 6.2 API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ›´æ–°

#### 6.2.1 ç’°å¢ƒå¤‰æ•°è¨­å®š
```python
# backend/config.py
import os
from pydantic import BaseSettings

class Settings(BaseSettings):
    # API Keys
    alpha_vantage_api_key: str = ""
    openweather_api_key: str = ""
    
    # Cache settings
    cache_backend: str = "memory"  # "memory" | "redis"
    redis_url: str = "redis://localhost:6379"
    
    # Rate limiting
    rate_limit_per_minute: int = 60
    
    class Config:
        env_file = ".env"

settings = Settings()
```

#### 6.2.2 ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Ÿè£…
```python
# backend/cache/cache_manager.py
from typing import Optional, Any
import json
import time
from abc import ABC, abstractmethod

class CacheBackend(ABC):
    @abstractmethod
    async def get(self, key: str) -> Optional[str]:
        pass
    
    @abstractmethod  
    async def set(self, key: str, value: str, expire: int) -> None:
        pass

class MemoryCache(CacheBackend):
    def __init__(self):
        self._cache = {}
    
    async def get(self, key: str) -> Optional[str]:
        item = self._cache.get(key)
        if item and item["expire"] > time.time():
            return item["value"]
        elif item:
            del self._cache[key]
        return None
    
    async def set(self, key: str, value: str, expire: int) -> None:
        self._cache[key] = {
            "value": value,
            "expire": time.time() + expire
        }

class CacheManager:
    def __init__(self, backend: CacheBackend):
        self.backend = backend
    
    async def get_or_set(self, key: str, factory, expire: int = 3600):
        """ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã€ãªã‘ã‚Œã° factory ã§ç”Ÿæˆã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥"""
        cached = await self.backend.get(key)
        if cached:
            return json.loads(cached)
        
        # ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        data = await factory()
        await self.backend.set(key, json.dumps(data), expire)
        return data
```

## 7. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 7.1 ä¸¦åˆ—å‡¦ç†
```python
# è¤‡æ•°éŠ˜æŸ„ã®ä¸¦åˆ—å–å¾—
async def get_multiple_stocks(symbols: List[str], period: str) -> Dict:
    tasks = [
        stock_service.get_stock_data(symbol, period) 
        for symbol in symbols
    ]
    results = await asyncio.gather(*tasks, return_exceptions=True)
    
    stocks = []
    for symbol, result in zip(symbols, results):
        if isinstance(result, Exception):
            print(f"Failed to get data for {symbol}: {result}")
            continue
        stocks.append(result)
    
    return {"stocks": stocks}
```

### 7.2 ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾å¿œ
```python
# backend/middleware/rate_limiter.py
import time
from collections import defaultdict
from fastapi import HTTPException, Request

class RateLimiter:
    def __init__(self, max_requests: int = 60, window: int = 60):
        self.max_requests = max_requests
        self.window = window
        self.requests = defaultdict(list)
    
    def is_allowed(self, client_ip: str) -> bool:
        now = time.time()
        # å¤ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‰Šé™¤
        self.requests[client_ip] = [
            req_time for req_time in self.requests[client_ip]
            if now - req_time < self.window
        ]
        
        if len(self.requests[client_ip]) >= self.max_requests:
            return False
        
        self.requests[client_ip].append(now)
        return True
```

## 8. é‹ç”¨ãƒ»ç›£è¦–

### 8.1 ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æ‹¡å¼µ
```python
# backend/api/health.py
@router.get("/health")
async def health_check():
    checks = {
        "yahoo_finance": await check_yahoo_finance(),
        "alpha_vantage": await check_alpha_vantage(),
        "jma_api": await check_jma_api(),
        "cache": await check_cache()
    }
    
    all_healthy = all(check["status"] == "healthy" for check in checks.values())
    
    return {
        "status": "healthy" if all_healthy else "degraded",
        "services": checks,
        "timestamp": datetime.utcnow().isoformat()
    }
```

### 8.2 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
```python
# æ®µéšçš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
async def get_data_with_fallback(symbol: str, period: str):
    providers = [
        ("yahoo_finance", lambda: get_yahoo_data(symbol, period)),
        ("alpha_vantage", lambda: get_alpha_vantage_data(symbol, period)),
        ("mock_data", lambda: get_mock_data(symbol, period))
    ]
    
    for provider_name, provider_func in providers:
        try:
            data = await provider_func()
            return data
        except Exception as e:
            print(f"{provider_name} failed: {e}")
            continue
    
    raise Exception("All data providers failed")
```

## 9. é–‹ç™ºç’°å¢ƒè¨­å®š

### 9.1 ç’°å¢ƒå¤‰æ•°ï¼ˆ.envï¼‰
```bash
# Stock Data APIs
ALPHA_VANTAGE_API_KEY=your_alpha_vantage_key
OPENWEATHER_API_KEY=your_openweather_key

# Cache
CACHE_BACKEND=memory
REDIS_URL=redis://localhost:6379

# Rate Limiting
RATE_LIMIT_PER_MINUTE=60

# Development
DEBUG=true
LOG_LEVEL=INFO
```

### 9.2 ä¾å­˜é–¢ä¿‚ï¼ˆrequirements.txtï¼‰
```
# Core
fastapi==0.103.0
uvicorn==0.23.0
pydantic==2.4.0

# Stock Data
yfinance==0.2.18
httpx==0.25.0
pandas==2.1.0

# Cache (optional)
redis==5.0.0

# Development
pytest==7.4.0
pytest-asyncio==0.21.0
```

## 10. APIåˆ¶é™ã¨å¯¾ç­–

### 10.1 åˆ¶é™ä¸€è¦§
| API | ç„¡æ–™æ  | åˆ¶é™å¯¾ç­– |
|-----|--------|----------|
| yfinance | å®Ÿè³ªç„¡é™ | ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£… |
| Alpha Vantage | 25req/æ—¥ | ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ |
| æ°—è±¡åº | åˆ¶é™ãªã— | - |
| OpenWeather | 1000req/æ—¥ | ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ |

### 10.2 ã‚³ã‚¹ãƒˆæœ€é©åŒ–
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ´»ç”¨**: 15åˆ†é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§APIå‘¼ã³å‡ºã—ã‚’å‰Šæ¸›
- **ãƒãƒƒãƒå‡¦ç†**: è¤‡æ•°éŠ˜æŸ„ã®ä¸€æ‹¬å–å¾—
- **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: ç„¡æ–™APIã®çµ„ã¿åˆã‚ã›ã§å†—é•·æ€§ç¢ºä¿

---

**ä½œæˆæ—¥**: 2025å¹´9æœˆ20æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0  
**å¯¾è±¡ãƒ•ã‚§ãƒ¼ã‚º**: Phase 1 MVP